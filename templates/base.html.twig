
{# templates/base.html.twig #}
<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Todo App{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  {# Apply saved theme early to avoid FOUC #}
  <script>
    (function () {
      try {
        const KEY = 'theme';
        const saved = localStorage.getItem(KEY);
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved ? saved : (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-bs-theme', theme);
      } catch {}
    })();
  </script>

  {# Bootstrap CSS #}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  {# Bootstrap Icons #}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  {# Smooth theme transitions (optional) #}
  <style>
    html, body, .card, .navbar, .list-group-item, .dropdown-menu, .table, .modal-content {
      transition: background-color .2s ease, color .2s ease, border-color .2s ease;
    }
  </style>
</head>

{# IMPORTANT: use bg-body, not bg-light #}
<body class="bg-body" style="font-size: 1.12rem;">

  {# Navbar: use bg-body-tertiary so it adapts to dark mode #}
  <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm mb-4">
    <div class="container">

      <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="{{ path('task_index') }}">
        <i class="bi bi-check2-square text-primary fs-4"></i>
        Todo App
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu"
              aria-controls="navbarMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarMenu">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          {% set loggedIn = app.request.session.get('user_id') is not empty %}

          {% if loggedIn %}
            <li class="nav-item d-flex align-items-center me-3">
              <span class="text-muted">Hi, <strong>{{ app.request.session.get('username') }}</strong></span>
            </li>
            <li class="nav-item me-2">
              <a href="{{ path('auth_logout') }}" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-box-arrow-right"></i> Logout
              </a>
            </li>
          {% else %}
            <li class="nav-item me-2">
              <a href="{{ path('auth_login') }}" class="btn btn-outline-primary btn-sm">Login</a>
            </li>
            <li class="nav-item me-2">
              <a href="{{ path('auth_register') }}" class="btn btn-primary btn-sm">Register</a>
            </li>
          {% endif %}

          {# Theme toggle button #}
          <li class="nav-item">
            <button id="themeToggle" class="btn btn-outline-secondary btn-sm" type="button"
                    aria-label="Toggle color theme" aria-pressed="false">
              <i class="bi"></i>
              <span class="d-none d-sm-inline ms-1">Theme</span>
            </button>
          </li>
        </ul>
      </div>

    </div>
  </nav>

  <div class="container">
    {# Flash Messages #}
    {% for label, messages in app.flashes %}
      {% for message in messages %}
        <div class="alert alert-{{ label }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endfor %}

    {% block body %}{% endblock %}
  </div>

  {# Bootstrap JS #}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>

  {# Theme toggle logic #}
  <script>
    (function () {
      const KEY = 'theme';
      const btn = document.getElementById('themeToggle');
      if (!btn) return;

      const icon = btn.querySelector('i');

      const getTheme = () => document.documentElement.getAttribute('data-bs-theme') || 'light';
      const setTheme = (t) => {
        document.documentElement.setAttribute('data-bs-theme', t);
        try { localStorage.setItem(KEY, t); } catch {}
        updateIcon(t);
      };
      const updateIcon = (t) => {
        if (!icon) return;
        if (t === 'dark') { icon.className = 'bi bi-sun-fill'; btn.setAttribute('aria-pressed', 'true'); }
        else { icon.className = 'bi bi-moon-stars-fill'; btn.setAttribute('aria-pressed', 'false'); }
      };

      btn.addEventListener('click', () => setTheme(getTheme() === 'dark' ? 'light' : 'dark'));
      updateIcon(getTheme());

      // Optional: follow system if no explicit choice was set
      try {
        if (!localStorage.getItem(KEY) && window.matchMedia) {
          window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            setTheme(e.matches ? 'dark' : 'light');
          });
        }
      } catch {}
    })();
  </script>

</body>
</html>
